<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body class="has-header">
<div class="wrapper-container">
  <div class="wrapper">
    <div class="header"><div class="company-logo"></div></div>

    <div class="content">
      <p id="feedback"></p>
    </div>
  </div>
</div>
</body>
</html>
<!-- This webpage will do a lot of redirects and is essentially a JS-based OpenID Connect client -->
<script type="text/javascript">
  var clientId = "35792b8a-8085-4946-b9ef-1092bcafe07c";
  var clientSecret = "3f73025d-bcab-4f90-80bc-9263c6641752";
  var scope = "openid profile";
  var acr = "urn:signicat:oidc:method:dummy-auth";
  var state = Math.random().toString(36);
  var redirectUri = encodeURI("http://localhost:1337/static/recover.html");
  var authorizeUri = "https://dev01.signicat.com/oidc/authorize";
  var tokenUri = "https://dev01.signicat.com/oidc/token";
  var userinfoUri = "https://dev01.signicat.com/oidc/userinfo";

  // ###### END OF CONFIGURABLE VARS ######
    function getParameterByName(name, url) {
    if (!url) {
      url = window.location.href;
    }
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

    var authorizeUri = authorizeUri + "?response_type=code"
  + "&redirect_uri=" + redirectUri
  + "&client_id=" + clientId
  + "&scope=" + scope
  + "&state=" + state
  + "&acr_values=" + acr;

  var code = getParameterByName('code');
  if (code) {
    state = getParameterByName('state');
    if (state != window.sessionStorage.getItem('state')) {
      alert("WARNING!, CSRF attempt halted!");
    } else {
      codeToMasterKey(getParameterByName("code"));
    }
  } else {
    window.sessionStorage.setItem('state', state);
    window.location= authorizeUri;
  }

  function codeToMasterKey(code) {
  var authorizationString = "Basic " + btoa(clientId + ":" + clientSecret);
        var tokenParams = {
          "grant_type": "authorization_code",
          "code": code,
          "redirect_uri": redirectUri};
        $.ajax({
        type: "POST",
        url: tokenUri,
        headers: { "Authorization": authorizationString},
        data: tokenParams,
        accept: 'application/json',
        async: true,
        success: function (data, textStatus, request) {
          var idToken = data.id_token;
          $.ajax({
            type: "POST",
            url: '/chain/authenticated',
            data: {"ass": idToken},
            async: true,
            success: function (data, textStatus, request) {
            window.localStorage.setItem("blockchain.masterkey", data);
                var desc = $("#feedback");
                desc.html("Authentication succeeded. The node network yielded the necessary key parts to rebuild your master key. Click <a href=\"/static/index.html\">here</a> to return to the previous page. Your current Master Key ID is " + JSON.parse(data).kid);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert("Whoops! " + textStatus + ": " +  errorThrown);
            }
          });
          },
          error: function(jqXHR, textStatus, errorThrown) {
              alert("Whoops! " + textStatus + ": " +  errorThrown);
          }
        });


  }


</script>